<!-- ✂️ (START OF <script type="module"> block replacement) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getDatabase, ref, push, onChildAdded, update, onValue
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA6uktBRcEfxGFaVx97ujxVzI5_EbNuEEo",
    authDomain: "happyfeed-af48f.firebaseapp.com",
    projectId: "happyfeed-af48f",
    storageBucket: "happyfeed-af48f.appspot.com",
    messagingSenderId: "456897128438",
    appId: "1:456897128438:web:1cfc3fe338df22498549d7",
    databaseURL: "https://happyfeed-af48f-default-rtdb.firebaseio.com"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const chatBox = document.getElementById('chatBox');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const nameInput = document.getElementById('nameInput');
  const recipientInput = document.getElementById('recipientInput');
  const saveNameBtn = document.getElementById('saveNameBtn');
  const imageInput = document.getElementById('imageInput');
  const chooseImageBtn = document.getElementById('chooseImageBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const imagePreview = document.getElementById('imagePreview');

  let selectedFile = null;

  saveNameBtn.addEventListener("click", () => {
    const name = nameInput.value.trim();
    if (name) {
      localStorage.setItem("username", name);
      alert("Name saved!");
      loadMessagesFor(name);
    }
  });

  sendBtn.addEventListener("click", sendMessage);
  msgInput.addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
  });

  function sendMessage() {
    const text = msgInput.value.trim();
    const sender = localStorage.getItem("username") || "Anonymous";
    const recipient = recipientInput.value.trim();
    if (!text || !recipient) return;

    const message = {
      text,
      username: sender,
      to: recipient,
      timestamp: Date.now(),
      status: "sent"
    };

    const recipientRef = ref(db, `privateMessages/${recipient}/${sender}`);
    const newRecipientMsg = push(recipientRef);
    update(newRecipientMsg, { ...message, status: "delivered" });

    const senderRef = ref(db, `privateMessages/${sender}/${recipient}`);
    push(senderRef, message);

    msgInput.value = "";
  }

  function renderMessage(msg, msgKey, conversationKey) {
    const msgElement = document.createElement("div");
    const currentUser = localStorage.getItem("username") || "Anonymous";
    const isSent = msg.username === currentUser;

    msgElement.classList.add(isSent ? "sent" : "received");
    const directionText = isSent ? `You → ${msg.to}` : `${msg.username} → You`;

    let content = "";

    if (msg.imageUrl) {
      content = `<strong>${directionText}</strong><br><img src="${msg.imageUrl}" style="max-width:200px;"><br>`;
    } else {
      content = `<strong>[${directionText}]</strong>: ${msg.text}`;
    }

    if (isSent && msg.status) {
      content += `<br><small>Status: ${msg.status}</small>`;
    }

    msgElement.innerHTML = content;
    chatBox.appendChild(msgElement);
    chatBox.scrollTop = chatBox.scrollHeight;

    // If message was sent TO this user and not marked as read, mark it
    if (!isSent && msg.status !== "read") {
      const msgRef = ref(db, `privateMessages/${currentUser}/${conversationKey}/${msgKey}`);
      update(msgRef, { status: "read" });
    }
  }

  function loadMessagesFor(username) {
    chatBox.innerHTML = "";
    const userInboxRef = ref(db, `privateMessages/${username}`);

    onChildAdded(userInboxRef, (conversationSnapshot) => {
      const conversationKey = conversationSnapshot.key;
      const messagesRef = ref(db, `privateMessages/${username}/${conversationKey}`);

      onChildAdded(messagesRef, (msgSnapshot) => {
        const msg = msgSnapshot.val();
        renderMessage(msg, msgSnapshot.key, conversationKey);
      });
    });
  }

  const savedUsername = localStorage.getItem("username");
  if (savedUsername) {
    loadMessagesFor(savedUsername);
    nameInput.value = savedUsername;
  }

  chooseImageBtn.addEventListener("click", () => imageInput.click());

  imageInput.addEventListener("change", () => {
    selectedFile = imageInput.files[0];
    if (selectedFile) {
      const reader = new FileReader();
      reader.onload = e => {
        imagePreview.src = e.target.result;
        imagePreview.style.display = "inline-block";
      };
      reader.readAsDataURL(selectedFile);
    } else {
      imagePreview.src = "";
      imagePreview.style.display = "none";
    }
  });

  uploadBtn.addEventListener("click", async () => {
    if (!selectedFile) return alert("Please choose an image first.");
    const recipient = recipientInput.value.trim();
    const username = localStorage.getItem("username") || "Anonymous";
    if (!recipient) return alert("Enter a recipient before sending an image.");

    const formData = new FormData();
    formData.append("image", selectedFile);
    try {
      const res = await fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: {
          Authorization: "Client-ID bf20b916779ba44"
        },
        body: formData
      });
      const data = await res.json();
      if (data.success) {
        const imageUrl = data.data.link;
        const message = { imageUrl, username, to: recipient, timestamp: Date.now(), status: "sent" };

        const recipientRef = ref(db, `privateMessages/${recipient}/${username}`);
        const newRecipientMsg = push(recipientRef);
        update(newRecipientMsg, { ...message, status: "delivered" });

        const senderRef = ref(db, `privateMessages/${username}/${recipient}`);
        push(senderRef, message);

        imagePreview.src = "";
        imagePreview.style.display = "none";
        imageInput.value = "";
        selectedFile = null;
      } else {
        alert("Image upload failed.");
      }
    } catch (err) {
      alert("Error uploading image.");
      console.error(err);
    }
  });
</script>
<!-- ✂️ (END OF <script type="module"> block replacement) -->
